name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: nebula-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 发布到 crates.io
  publish-cargo:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "nebula-publish"
          cache-targets: false

      - name: Validate Cargo.toml
        run: |
          cargo check --package nebula-core
          cargo check --package nebula-client || echo "No client package"
          cargo check --package nebula-server || echo "No server package"

      - name: Get crates.io Auth Token
        uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish to crates.io
        run: |
          cargo publish -p nebula-core
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  # 多平台构建
  build-release:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        include:
          - os: ubuntu-latest
            artifact_name: nebula-id
            asset_name: nebula-id-linux-x86_64.tar.gz
          - os: windows-latest
            artifact_name: nebula-id.exe
            asset_name: nebula-id-windows-x86_64.zip
          - os: macos-latest
            artifact_name: nebula-id
            asset_name: nebula-id-macos-x86_64.tar.gz

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "nebula-build-${{ matrix.os }}"
          cache-targets: false

      - name: Build Release Binary
        run: cargo build --release --locked

      - name: Create Artifact
        run: |
          mkdir -p release
          cp target/release/${{ matrix.artifact_name }} release/
          cd release
          if [[ "${{ matrix.os }}" == *"windows"* ]]; then
            tar -czf ../${{ matrix.asset_name }} .
          else
            if [[ "${{ matrix.os }}" == *"ubuntu"* ]]; then
              tar -czf ../${{ matrix.asset_name }} .
            else
              tar -czf ../${{ matrix.asset_name }} .
            fi
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: release/${{ matrix.asset_name }}
          compression-level: 9
          retention-days: 30

  # 创建 GitHub Release
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-release
    if: always() && (needs.build-release.result != 'skipped')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
        continue-on-error: true

      - name: List Artifacts
        run: |
          echo "=== Artifacts downloaded ==="
          if [ -d "artifacts" ] && [ "$(ls -A artifacts 2>/dev/null)" ]; then
            ls -la artifacts/
            echo "Found $(find artifacts -type f | wc -l) artifact(s)"
          else
            echo "⚠️ No artifacts found!"
          fi
          echo "============================"

      - name: Check Build Status
        run: |
          BUILD_RESULT="${{ needs.build-release.result }}"
          echo "Build matrix result: $BUILD_RESULT"
          if [[ "$BUILD_RESULT" != "success" ]]; then
            echo "⚠️ Some platform builds may have failed"
          fi

      - name: Check if artifacts exist
        id: check-artifacts
        run: |
          if [ -d "artifacts" ] && [ "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release (with artifacts)
        if: steps.check-artifacts.outputs.has_artifacts == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          name: Release v${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release (without artifacts - tag only)
        if: steps.check-artifacts.outputs.has_artifacts == 'false'
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 通知状态
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [publish-cargo, github-release]
    if: always()
    steps:
      - name: Check Release Status
        run: |
          CARGO_STATUS="${{ needs.publish-cargo.result }}"
          GITHUB_STATUS="${{ needs.github-release.result }}"
          
          echo "================================"
          echo "  Release Pipeline Summary"
          echo "================================"
          echo ""
          echo "Cargo Publish: $CARGO_STATUS"
          echo "GitHub Release: $GITHUB_STATUS"
          echo ""
          
          if [[ "$GITHUB_STATUS" == "success" ]]; then
            echo "✅ GitHub Release created successfully!"
            echo "  - Tag: v${{ github.ref_name }}"
            echo "  - URL: https://github.com/${{ github.repository }}/releases/tag/v${{ github.ref_name }}"
          fi
          
          if [[ "$CARGO_STATUS" != "success" ]]; then
            echo "❌ Cargo publish failed or skipped"
          fi
          
          echo ""
          echo "================================"