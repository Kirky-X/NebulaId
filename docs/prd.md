# 产品需求文档 (PRD)

## 企业级分布式 ID 生成系统

**版本**: v1.1
**创建日期**: 2025-12-24  
**产品负责人**: 技术团队  
**状态**: ⏳ 待评审

---

## 一、产品概述

### 1.1 产品定位

企业级分布式 ID 生成系统，为多业务系统提供高性能、高可用、全局唯一的 ID 生成服务，支持跨数据中心部署，具备智能算法切换和自适应性能优化能力。

### 1.2 目标用户

- **主要用户**: 企业内部研发团队、微服务架构开发者
- **使用场景**: 订单号、用户ID、流水号、追踪ID等业务场景
- **用户规模**: 支持 100+ 业务系统接入

### 1.3 核心价值

- **高性能**: 单实例支持 **百万级 (1,000,000+) QPS**，P99 延迟 < 10ms
- **高可用**: 多级降级策略，系统可用性 > 99.99%
- **易扩展**: 支持横向扩容，跨数据中心部署
- **易管理**: 提供可视化管理后台和完善的监控体系

---

## 二、功能需求

### 2.1 核心功能

#### F1. ID 生成服务 ⏳ 待开发

**用户故事**:  
作为业务系统开发者，我希望通过 HTTP/gRPC 接口快速获取全局唯一的 ID，以便在分布式环境下保证数据一致性。

**功能描述**:

- 支持单个 ID 生成
- 支持批量 ID 生成（1-1000个）
- 支持多种 ID 格式：纯数字、带前缀、UUID 格式
- **认证机制**: 强制要求 `X-API-Key` 请求头
- 响应时间 < 10ms (P99)

**验收标准**:

- [ ] HTTP API `/api/v1/generate` 返回单个 ID
- [ ] gRPC API `Generate()` 返回单个 ID
- [ ] 批量生成接口 `/api/v1/generate/batch` 支持 size 参数
- [ ] **P99 延迟 < 10ms（在 100万 QPS 压力下）**
- [ ] **单实例 QPS > 1,000,000**

#### F2. 多算法引擎支持 ⏳ 待开发

**用户故事**:  
作为系统管理员，我希望根据业务场景选择不同的 ID 生成算法（号段模式/雪花算法/UUID），以便平衡性能、顺序性和分布式特性。

**功能描述**:

- **Segment 算法**: 号段模式，数据库号段预分配，支持双缓冲预加载
- **Snowflake 算法**: 时间戳+机器ID+序列号，支持逻辑时钟抗回拨
- **UUID v7 算法**: 基于时间的 UUID
- 支持按 **业务标签 (biz_tag)** 配置算法类型

**验收标准**:

- [ ] 每种算法独立实现并通过单元测试
- [ ] 算法路由器能根据配置选择正确算法
- [ ] 支持通过 API 参数指定算法（可选）

#### F3. 智能号段管理 ⏳ 待开发

**用户故事**:  
作为系统管理员，我希望系统能根据实时流量自动调整号段步长，以便减少数据库访问频率并降低号段浪费。

**功能描述**:

- 动态计算号段步长（基于 QPS 和系统压力）
- **双缓冲机制 (DoubleBuffer)**：当前号段 + 预加载号段，无缝切换
- 号段快耗尽时（剩余 < 10%）异步加载，业务无感知
- 号段分配记录审计

**验收标准**:

- [ ] 低峰期步长自动降低（如 1000）
- [ ] 高峰期步长自动提升（如 10000）
- [ ] 号段剩余 10% 时触发预加载
- [ ] 预加载完成前不阻塞 ID 生成
- [ ] 号段浪费率 < 5%

#### F4. 跨数据中心支持 ⏳ 待开发

**用户故事**:  
作为运维工程师，我希望系统支持多数据中心部署并保证 ID 全局唯一，以便实现异地多活和容灾备份。

**功能描述**:

- 每个数据中心独立号段分配（预设 1万亿 ID 区间）
- 基于 etcd 的全局配置协调
- DC_ID 隔离（3位，支持8个数据中心）
- 跨 DC 号段不冲突

**验收标准**:

- [ ] 每个 DC 分配独立的 DC_ID (0-7)
- [ ] 不同 DC 生成的 ID 保证全局唯一（区间不重叠）
- [ ] DC 故障时其他 DC 正常服务
- [ ] etcd 集群故障时使用本地缓存配置

#### F5. 自动降级策略 ⏳ 待开发

**用户故事**:  
作为 SRE 工程师，我希望在底层依赖故障时系统能自动降级，以便保证服务持续可用。

**功能描述**:

- **正常模式**: Segment 号段算法
- **DB 故障降级**: 切换至 Snowflake 算法
- **时钟异常降级**: 
  - 微小回拨 (<5ms): 自旋等待
  - 中等回拨 (6-1000ms): 使用逻辑时钟
  - 严重回拨 (>1000ms): 切换至 UUID v7
- **全部故障降级**: 使用本地 UUID v4 + 告警

**验收标准**:

- [ ] PostgreSQL 连接失败时自动切换至 Snowflake
- [ ] 检测到时钟回拨时按策略处理（自旋/逻辑时钟/降级）
- [ ] 降级/恢复事件记录到审计日志
- [ ] 降级时触发告警通知

### 2.2 管理功能

#### F6. 配置管理 ⏳ 待开发

**用户故事**:  
作为业务接入者，我希望通过管理后台创建和管理业务单元配置，以便快速接入 ID 生成服务。

**功能描述**:

- 工作空间(Workspace)管理
- 分组(Group)管理
- **业务标签(BizTag)** 管理
- API Key 管理（生成、轮转、吊销）
- 算法配置、步长配置、格式配置

**验收标准**:

- [ ] 创建/编辑/删除 Workspace
- [ ] 创建/编辑/删除 Group
- [ ] 创建/编辑/删除 BizTag
- [ ] API Key 管理功能可用
- [ ] 配置修改后实时生效（< 5秒）

#### F7. 监控大盘 ⏳ 待开发

**用户故事**:  
作为运维工程师，我希望通过监控大盘实时查看系统运行状态，以便及时发现和解决问题。

**功能描述**:

- 实时 QPS、延迟、错误率监控
- 号段消耗速率监控
- 各算法使用比例统计
- 跨 DC 流量分布
- 集成 Grafana 仪表盘

**验收标准**:

- [ ] Grafana 仪表盘展示核心指标
- [ ] 数据刷新间隔 < 10秒
- [ ] 支持按时间范围查询（最近1小时/1天/7天）
- [ ] 支持按业务标签(biz_tag)过滤

#### F8. 告警管理 ⏳ 待开发

**用户故事**:  
作为 SRE 工程师，我希望系统能在异常情况下自动触发告警，以便快速响应和处理故障。

**功能描述**:

- 号段即将耗尽告警（剩余 < 10%）
- 数据库连接失败告警
- 算法降级告警
- QPS 异常告警（过高/过低）
- 延迟异常告警（P99 > 阈值）
- Worker ID 分配失败告警

**验收标准**:

- [ ] 集成 AlertManager
- [ ] 支持邮件/企业微信/钉钉通知
- [ ] 告警规则可配置
- [ ] 告警历史可查询

### 2.3 API 功能

#### F9. RESTful API ⏳ 待开发

**端点列表**:

| 方法 | 路径                     | 描述            | 状态     |
| ---- | ------------------------ | --------------- | -------- |
| POST | `/api/v1/generate`       | 生成单个 ID     | ⏳ 待开发 |
| POST | `/api/v1/generate/batch` | 批量生成 ID     | ⏳ 待开发 |
| POST | `/api/v1/parse`          | 解析 ID 信息    | ⏳ 待开发 |
| GET  | `/health`                | 健康检查        | ⏳ 待开发 |
| GET  | `/metrics`               | Prometheus 指标 | ⏳ 待开发 |

**验收标准**:

- [ ] 所有端点符合 RESTful 规范
- [ ] 返回标准 JSON 格式
- [ ] 错误处理规范（HTTP 状态码 + 错误详情）
- [ ] API 文档自动生成（OpenAPI 3.0）
- [ ] **必须验证 X-API-Key**

#### F10. gRPC API ⏳ 待开发

**服务定义**:

- `Generate(GenerateRequest) -> GenerateResponse`
- `BatchGenerate(BatchGenerateRequest) -> BatchGenerateResponse`
- `Parse(ParseRequest) -> IdInfo`
- `HealthCheck() -> HealthCheckResponse`

**验收标准**:

- [ ] 所有 RPC 方法正常工作
- [ ] 支持双向流式通信（批量场景）
- [ ] 集成 gRPC 健康检查协议
- [ ] 性能优于 HTTP (延迟降低 30%)

---

## 三、非功能需求

### 3.1 性能需求

| 指标           | 目标值                   | 验证方法     | 状态     |
| -------------- | ------------------------ | ------------ | -------- |
| **单实例 QPS** | **> 1,000,000 (百万级)** | 压力测试     | ⏳ 待验证 |
| **集群总 QPS** | > 10,000,000 (千万级)    | 压力测试     | ⏳ 待验证 |
| **P50 延迟**   | < 1ms                    | 压力测试     | ⏳ 待验证 |
| **P99 延迟**   | < 10ms                   | 压力测试     | ⏳ 待验证 |
| **P999 延迟**  | < 50ms                   | 压力测试     | ⏳ 待验证 |
| **并发连接数** | > 50,000                 | 连接池测试   | ⏳ 待验证 |
| **内存占用**   | < 4GB                    | 压力测试监控 | ⏳ 待验证 |

### 3.2 可用性需求

| 指标             | 目标值                     | 状态     |
| ---------------- | -------------------------- | -------- |
| **系统可用性**   | > 99.99% (年停机 < 53分钟) | ⏳ 待验证 |
| **故障恢复时间** | < 30秒 (自动故障转移)      | ⏳ 待验证 |
| **数据持久性**   | 号段分配记录 100% 持久化   | ⏳ 待验证 |

### 3.3 扩展性需求

| 需求           | 描述                           | 状态     |
| -------------- | ------------------------------ | -------- |
| **横向扩展**   | 支持动态增加节点，无需停机     | ⏳ 待实现 |
| **业务隔离**   | 支持 1000+ 业务标签(biz_tag)   | ⏳ 待实现 |
| **跨 DC 扩展** | 支持 8 个数据中心，ID 空间隔离 | ⏳ 待实现 |

### 3.4 安全性需求

| 需求           | 描述                                  | 状态     |
| -------------- | ------------------------------------- | -------- |
| **API 认证**   | **基于 Workspace 的 API Key 认证**    | ⏳ 待实现 |
| **传输加密**   | 支持 TLS 1.3 加密                     | ⏳ 待实现 |
| **访问控制**   | API 限流：1000 QPS/IP                 | ⏳ 待实现 |
| **密钥管理**   | API Key 定期轮转（90天）              | ⏳ 待实现 |
| **审计日志**   | 记录所有 API 调用、配置变更和告警事件 | ⏳ 待实现 |
| **数据库安全** | PostgreSQL 连接加密，密码轮转         | ⏳ 待实现 |

### 3.5 可维护性需求

| 需求           | 描述                              | 状态     |
| -------------- | --------------------------------- | -------- |
| **日志规范**   | 结构化日志(JSON)，日志级别可配置  | ⏳ 待实现 |
| **监控指标**   | Prometheus 格式，涵盖核心业务指标 | ⏳ 待实现 |
| **分布式追踪** | 集成 OpenTelemetry                | ⏳ 待实现 |
| **配置管理**   | 热更新配置，无需重启服务          | ⏳ 待实现 |

---

## 四、用户界面原型（管理后台）

### 4.1 主导航结构

```
管理后台
├── 仪表盘 (Dashboard)
│   ├── 实时监控
│   ├── QPS 趋势图
│   └── 告警汇总
├── 配置管理
│   ├── 工作空间列表
│   ├── 分组列表
│   ├── 业务标签列表 (BizTags)
│   └── API Key 管理
├── 监控告警
│   ├── 实时指标
│   ├── 告警历史
│   └── 告警规则配置
├── 审计日志
│   ├── 配置变更记录
│   ├── API 调用日志
│   └── 降级事件记录
└── 系统设置
    ├── 全局配置
    ├── 用户管理
    └── 权限管理
```

### 4.2 关键页面描述

#### 页面 1: 仪表盘 ⏳ 待设计

- **核心指标卡片**: 当前 QPS、平均延迟、成功率、告警数量
- **实时 QPS 折线图**: 最近 1 小时数据
- **算法使用分布饼图**: Segment/Snowflake/UUID 比例
- **跨 DC 流量分布**: 各数据中心 QPS 对比

#### 页面 2: 业务标签配置 ⏳ 待设计

- **列表视图**: 显示所有业务标签及其配置
- **创建/编辑表单**: 
  - 基本信息：名称、描述
  - 算法选择：Segment/Snowflake/UUID v7
  - 格式配置：ID 前缀、长度
  - 性能配置：基准步长、缓存大小

#### 页面 3: 监控大盘 ⏳ 待设计

- **集成 Grafana 仪表盘**: iframe 嵌入
- **快捷筛选**: 按业务标签、时间范围、数据中心筛选
- **关键指标**: QPS、延迟、错误率、号段消耗速率

---

## 五、验收标准总结

### 5.1 功能验收 ⏳ 待验收

- [ ] 所有核心 API 正常工作且通过 API Key 认证
- [ ] 3 种算法（Segment/Snowflake/UUID）通过测试
- [ ] 自动降级策略（含时钟回拨处理）在模拟故障下正常工作
- [ ] 管理后台基本功能可用

### 5.2 性能验收 ⏳ 待验收

- [ ] **压测达到 1,000,000 QPS**
- [ ] P99 延迟 < 10ms
- [ ] 内存占用 < 4GB

### 5.3 可用性验收 ⏳ 待验收

- [ ] 数据库故障自动降级，RTO < 30s
- [ ] etcd 故障服务正常运行（使用缓存配置）
- [ ] 单节点故障不影响整体服务
- [ ] 跨 DC 部署无 ID 冲突

### 5.4 安全验收 ⏳ 待验收

- [ ] TLS 加密正常工作
- [ ] API Key 认证生效，无效 Key 返回 401
- [ ] API 限流生效
- [ ] 审计日志完整记录

---

## 六、项目里程碑

| 阶段        | 时间       | 交付物                                   | 状态     |
| ----------- | ---------- | ---------------------------------------- | -------- |
| **Phase 1** | Week 1-4   | 基础架构 + 核心算法 (含百万级优化)       | ⏳ 待开始 |
| **Phase 2** | Week 5-8   | 高可用 + 跨 DC 支持 + Worker ID 自动分配 | ⏳ 待开始 |
| **Phase 3** | Week 9-11  | 监控告警 + 管理后台 + API Key 认证       | ⏳ 待开始 |
| **Phase 4** | Week 12-14 | 压测优化 + 上线                          | ⏳ 待开始 |

---

## 七、风险与假设

### 7.1 关键假设

- PostgreSQL 作为主数据库可满足性能需求
- Redis 集群提供稳定的缓存服务
- etcd 集群网络延迟 < 5ms

### 7.2 已识别风险

| 风险             | 影响 | 应对措施                               | 状态     |
| ---------------- | ---- | -------------------------------------- | -------- |
| SeaORM 性能瓶颈  | 高   | 提前性能测试，准备 SQLx 备选方案       | ⏳ 待评估 |
| 跨 DC 号段冲突   | 高   | 严格的 DC_ID 分配机制 + 预分配 1T 区间 | ⏳ 待验证 |
| 时钟回拨导致阻塞 | 中   | 采用非阻塞等待队列 + 逻辑时钟          | ⏳ 待实施 |

---

## 八、附录

### 8.1 术语表

- **Workspace**: 工作空间，顶层逻辑隔离单元
- **Group**: 分组，业务系统级别的隔离
- **BizTag (Business Tag)**: 业务标签，具体的 ID 类型（原 Name）
- **Segment**: 号段，预分配的 ID 范围
- **DC_ID**: 数据中心标识符，用于跨 DC 隔离

### 8.2 参考资料

- 美团 Leaf 技术方案: https://tech.meituan.com/2017/04/21/mt-leaf.html
- 百度 UidGenerator: https://github.com/baidu/uid-generator
- 滴滴 TinyID: https://github.com/didi/tinyid

---

**文档状态**: ⏳ 待评审  
**下次评审日期**: 待定  
**评审参与者**: 产品经理、技术负责人、架构师