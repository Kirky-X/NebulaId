# 用户验收文档 (UAT)
## 企业级分布式 ID 生成系统

**版本**: v1.1
**创建日期**: 2025-12-24  
**验收负责人**: 产品经理 + 业务方代表  
**状态**: ⏳ 待验收

---

## 一、验收概述

### 1.1 验收目标
通过端到端的业务场景测试，验证系统是否满足业务需求，确保系统可以安全上线并为业务系统提供稳定的 ID 生成服务。

### 1.2 验收范围

| 验收类型 | 描述 | 状态 |
|---------|------|------|
| **功能验收** | 核心业务功能正常工作 | ⏳ 待验收 |
| **性能验收** | 满足修正后的性能指标要求 (**百万级 QPS**) | ⏳ 待验收 |
| **易用性验收** | API 易于集成，管理后台易用 | ⏳ 待验收 |
| **可靠性验收** | 故障场景下服务可用（含时钟回拨） | ⏳ 待验收 |
| **安全验收** | API Key 认证、限流、审计 | ⏳ 待验收 |

### 1.3 验收环境
- **环境**: 预生产环境（与生产环境配置一致）
- **节点数**: 3 节点集群
- **数据库**: PostgreSQL 16 + Patroni
- **缓存**: Redis 7.2 集群（3主3从）
- **配置中心**: etcd 3.5 集群
- **监控**: Prometheus + Grafana

---

## 二、业务场景验收

### 2.1 场景 1: 订单系统接入 ⏳ 待验收

**业务背景**:  
电商订单系统每天产生约 10万 笔订单，需要为每笔订单生成唯一的订单号，要求趋势递增便于分库分表。

**验收步骤**:

1. **配置创建** ⏳ 待验收
   - 登录管理后台
   - 创建工作空间: `ecommerce`
   - 创建分组: `order-system`
   - 创建业务标签 (BizTag): `order-id`
     - 算法: Segment
     - 格式: 纯数字
     - 基准步长: 10000 (修正: 适应高并发)
   - 生成 API Key: `idgen_ecommerce_...`
   - **验收标准**: 配置保存成功，5 秒内生效

2. **API 集成测试 (含认证)** ⏳ 待验收
   ```python
   # 业务系统代码示例
   import requests
   
   def create_order():
       # 生成订单 ID
       resp = requests.post(
           'https://idgen.company.com/api/v1/generate', 
           headers={'X-API-Key': 'idgen_ecommerce_...'},
           json={
               'workspace': 'ecommerce',
               'group': 'order-system',
               'biz_tag': 'order-id'
           }
       )
       order_id = resp.json()['id']
       
       # 创建订单
       db.orders.insert({
           'order_id': order_id,
           'user_id': 12345,
           'total': 99.99
       })
   ```
   - **验收标准**: 
     - 订单 ID 生成成功
     - 响应时间 < 10ms
     - 订单 ID 唯一且递增

3. **批量生成测试** ⏳ 待验收
   - 批量生成 1000 个订单 ID
   - **验收标准**: 
     - 总耗时 < 100ms
     - 所有 ID 唯一
     - ID 趋势递增

4. **高峰期压测** ⏳ 待验收
   - 模拟双11高峰：QPS = 100,000（订单创建）
   - **验收标准**: 
     - P99 延迟 < 10ms
     - 无错误

**预期结果**: ✅ 订单系统成功接入，满足业务需求

---

### 2.2 场景 2: 用户系统接入（Snowflake 算法） ⏳ 待验收

**业务背景**:  
用户注册系统需要为每个新用户生成唯一的用户 ID，要求无需数据库交互以降低依赖。

**验收步骤**:

1. **配置创建** ⏳ 待验收
   - 创建工作空间: `user-platform`
   - 创建分组: `user-system`
   - 创建业务标签 (BizTag): `user-id`
     - 算法: Snowflake
     - 格式: 纯数字 (19 位)
   - 生成 API Key
   - **验收标准**: 配置保存成功

2. **API 测试** ⏳ 待验收
   ```bash
   curl -X POST https://idgen.company.com/api/v1/generate \
     -H "Content-Type: application/json" \
     -H "X-API-Key: idgen_user_platform_..." \
     -d '{
       "workspace": "user-platform",
       "group": "user-system",
       "biz_tag": "user-id"
     }'
   ```
   - **验收标准**: 返回 19 位数字用户 ID

3. **解析 ID 信息** ⏳ 待验收
   ```bash
   curl -X POST https://idgen.company.com/api/v1/parse \
     -H "X-API-Key: idgen_user_platform_..." \
     -d '{"id": "1234567890123456789"}'
   ```
   - **验收标准**: 返回时间戳、数据中心 ID、机器 ID

4. **并发测试** ⏳ 待验收
   - 1000 并发请求
   - **验收标准**: 
     - 所有 ID 唯一
     - P99 < 10ms

**预期结果**: ✅ 用户系统成功接入，Snowflake 算法工作正常

---

### 2.3 场景 3: 物流系统接入（带前缀 ID） ⏳ 待验收

**业务背景**:  
物流追踪系统需要为每个运单生成追踪号，格式要求：`WB` + 时间戳 + 序号（如 `WB20251223001234`）

**验收步骤**:

1. **配置创建** ⏳ 待验收
   - 创建业务标签 (BizTag): `waybill-id`
     - 算法: Segment
     - 格式: Prefixed
     - 前缀: `WB`
     - 时间格式: `YYYYMMDD`
   - **验收标准**: 配置保存成功

2. **生成带前缀 ID** ⏳ 待验收
   ```bash
   curl -X POST https://idgen.company.com/api/v1/generate \
     -H "X-API-Key: idgen_logistics_..." \
     -d '{
       "workspace": "logistics",
       "group": "waybill-system",
       "biz_tag": "waybill-id"
     }'
   ```
   - **预期响应**: `{"id": "WB20251223001234"}`
   - **验收标准**: ID 格式符合业务要求

3. **日期切换测试** ⏳ 待验收
   - 在 23:59 和 00:01 分别生成 ID
   - **验收标准**: 
     - 日期部分正确切换
     - 序号从头开始

**预期结果**: ✅ 物流系统成功接入，自定义格式工作正常

---

### 2.4 场景 4: 跨数据中心部署与全球化验证 ⏳ 待验收

**业务背景**:  
公司在北京、上海两地有数据中心，未来计划扩展至新加坡。需要验证跨 DC 部署时 ID 全局唯一、配置准实时同步以及全球化时区处理。

**验收步骤**:

1. **部署与初始化验证** ⏳ 待验收
   - DC1 (北京): 3 个服务节点
   - DC2 (上海): 3 个服务节点
   - **验收标准**: 
     - 两个 DC 服务正常启动，通过 etcd 自动获取 `DC_ID` (分别为 0 和 1)
     - 数据库 Segment 号段在各 DC 自动初始化且不重叠

2. **全局唯一性与隔离测试** ⏳ 待验收
   - DC1 和 DC2 同时并发生成 100万 个 ID
   - 合并后去重
   - **验收标准**: 
     - 总数仍为 200万（无重复）
     - Snowflake ID 包含正确的 `DC_ID` 信息
     - Segment ID 步长与 DC 隔离逻辑正确

3. **配置全球同步测试** ⏳ 待验收
   - 在 DC1 管理后台修改某个 BizTag 的步长或告警阈值
   - **验收标准**: DC2 在 3 秒内获取到新配置并生效（通过 etcd watch）

4. **全球化时区验证** ⏳ 待验收
   - 模拟不同时区请求 ID
   - **验收标准**: 
     - Snowflake 时间戳统一使用 UTC
     - 日期前缀格式 (如 `WB20251224...`) 遵循配置指定的时区

5. **跨 DC 容灾切换** ⏳ 待验收
   - 停止 DC1 所有节点
   - 业务流量通过 DNS/负载均衡切换至 DC2
   - **验收标准**: 
     - 切换过程 ID 生成无冲突
     - 切换时间 < 5 秒
     - 数据库故障切换至备中心正常

**预期结果**: ✅ 跨 DC 部署与全球化验证通过，满足全球业务需求

---

## 三、管理功能验收

### 3.1 管理后台验收 ⏳ 待验收

#### 验收项 1: 配置管理界面 ⏳ 待验收

**操作流程**:
1. 登录管理后台: `https://idgen-admin.company.com`
2. 创建新工作空间
3. 在工作空间下创建分组
4. 在分组下创建业务标签 (BizTag)
5. 配置算法参数（步长、格式等）
6. 生成并复制 API Key
7. 保存配置

**验收标准**:
- [ ] UI 响应流畅（操作延迟 < 500ms）
- [ ] 表单验证完善（必填字段、格式校验）
- [ ] 配置保存成功后有明确提示
- [ ] 配置列表正确展示
- [ ] 支持编辑和删除（有二次确认）
- [ ] API Key 生成和复制功能正常

#### 验收项 2: 监控大盘 ⏳ 待验收

**操作流程**:
1. 进入监控大盘页面
2. 查看实时 QPS 趋势图
3. 查看延迟分布（P50/P90/P99）
4. 查看算法使用分布
5. 按业务标签 (BizTag) 筛选

**验收标准**:
- [ ] 数据实时刷新（延迟 < 10 秒）
- [ ] 图表清晰易读
- [ ] 支持时间范围选择（1h/1d/7d）
- [ ] 支持按 workspace/group/biz_tag 筛选
- [ ] 核心指标准确（与 Prometheus 对比）

#### 验收项 3: 告警管理 ⏳ 待验收

**操作流程**:
1. 配置告警规则（如号段剩余 < 10%）
2. 模拟告警场景
3. 查看告警历史
4. 确认告警通知（邮件/企业微信）

**验收标准**:
- [ ] 告警规则配置界面易用
- [ ] 告警触发及时（< 1 分钟）
- [ ] 告警通知送达正常
- [ ] 告警历史可查询

---

### 3.2 审计日志验收 ⏳ 待验收

**验收步骤**:

1. **配置变更审计** ⏳ 待验收
   - 修改某个业务标签的步长配置
   - 查询审计日志
   - **验收标准**: 
     - 记录包含时间、操作人、操作内容、变更前后值
     - 日志持久化，不可篡改

2. **告警事件审计** ⏳ 待验收
   - 触发一次号段耗尽告警
   - 查询审计日志
   - **验收标准**: 
     - 告警事件被记录
     - 包含告警级别、原因、恢复时间

3. **降级事件审计** ⏳ 待验收
   - 停止数据库触发降级
   - 查询审计日志
   - **验收标准**: 
     - 降级事件被记录
     - 包含降级原因、降级时长、恢复情况

**预期结果**: ✅ 审计日志完整可靠

---

## 四、非功能需求验收

### 4.1 性能验收 ⏳ 待验收

#### 验收项: 峰值 QPS 测试 (百万级) ⏳ 待验收

**测试配置**:
- 工具: wrk
- 并发数: 10,000
- 持续时间: 5 分钟
- 目标: 单实例 > 1,000,000 QPS

**执行命令**:
```bash
wrk -t 32 -c 10000 -d 300s \
  --latency \
  -H "X-API-Key: idgen_perf_key" \
  http://idgen.company.com/api/v1/generate
```

**验收标准**:
- [ ] **QPS > 1,000,000**
- [ ] P50 延迟 < 1ms
- [ ] P99 延迟 < 10ms
- [ ] 错误率 < 0.001%
- [ ] CPU 使用率 < 85%
- [ ] 内存占用 < 4GB

#### 验收项: 批量生成性能 ⏳ 待验收

**测试场景**: 批量生成 1000 个 ID

**验收标准**:
- [ ] 总耗时 < 100ms
- [ ] 平均单个 ID 生成时间 < 0.1ms

---

### 4.2 可靠性验收 ⏳ 待验收

#### 验收项 1: 数据库故障降级 ⏳ 待验收

**测试步骤**:
1. 正常生成 ID，记录算法为 Segment
2. 停止 PostgreSQL 服务
3. 继续生成 ID
4. 恢复 PostgreSQL 服务
5. 再次生成 ID

**验收标准**:
- [ ] 数据库故障时自动切换至 Snowflake 算法
- [ ] ID 生成无中断
- [ ] 降级响应时间 < 1 秒
- [ ] 数据库恢复后自动切回 Segment
- [ ] 告警被触发并通知

#### 验收项 2: Redis 故障容错 ⏳ 待验收

**测试步骤**:
1. 停止 Redis 集群
2. 生成 ID
3. 记录性能

**验收标准**:
- [ ] ID 生成成功（直接访问数据库）
- [ ] 延迟增加但仍 < 50ms
- [ ] 服务不中断

#### 验收项 3: 时钟回拨处理 (三级策略) ⏳ 待验收

**测试步骤**:
1. 使用 Snowflake 算法生成 ID
2. 手动调整系统时钟回拨 3ms (微小回拨)
3. 再次生成 ID
4. 手动调整系统时钟回拨 100ms (中等回拨)
5. 再次生成 ID
6. 手动调整系统时钟回拨 2000ms (严重回拨)
7. 再次生成 ID

**验收标准**:
- [ ] 微小回拨: 延迟略增，ID 正常生成
- [ ] 中等回拨: 立即生成，ID 使用逻辑时钟
- [ ] 严重回拨: 自动切换至 UUID v7 算法，ID 生成不中断
- [ ] 告警被触发

---

### 4.3 可用性验收 ⏳ 待验收

#### 验收项 1: 节点故障自愈 ⏳ 待验收

**测试步骤**:
1. 3 节点集群正常运行
2. Kill 其中 1 个节点
3. 观察服务状态
4. 节点自动重启（Kubernetes 拉起）

**验收标准**:
- [ ] 单节点故障不影响服务
- [ ] 负载自动转移到健康节点
- [ ] 节点重启后自动加入集群
- [ ] 总可用性 > 99.9%

#### 验收项 2: 滚动更新 ⏳ 待验收

**测试步骤**:
1. 部署新版本（滚动更新）
2. 持续发送请求

**验收标准**:
- [ ] 更新过程无服务中断
- [ ] 错误率 < 0.01%
- [ ] 更新完成时间 < 5 分钟

---

### 4.4 易用性验收 ⏳ 待验收

#### 验收项 1: API 易用性 ⏳ 待验收

**验收标准**:
- [ ] API 文档清晰完整（OpenAPI 规范）
- [ ] 错误信息友好（包含错误码和解决建议）
- [ ] 示例代码完整（Python/Java/Go）
- [ ] SDK 易于集成（< 10 行代码完成接入）

**示例: Python SDK**
```python
from idgen_client import IdGenClient

client = IdGenClient('https://idgen.company.com', api_key='idgen_...')
order_id = client.generate('ecommerce', 'order-system', 'order-id')
```

#### 验收项 2: 管理后台易用性 ⏳ 待验收

**用户体验评分** (1-5分，5分最高):
- [ ] 界面美观度: ≥ 4 分
- [ ] 操作流畅性: ≥ 4 分
- [ ] 功能易发现性: ≥ 4 分
- [ ] 错误提示友好性: ≥ 4 分

---

## 五、安全验收

### 5.1 传输安全验收 ⏳ 待验收

**验收项 1: HTTPS 强制**
- **测试**: 尝试 HTTP 请求
- **验收标准**: 自动重定向到 HTTPS 或拒绝连接

**验收项 2: TLS 版本**
- **测试**: 使用 TLS 1.2 和 TLS 1.3 连接
- **验收标准**: 
  - [ ] TLS 1.3 连接成功
  - [ ] TLS 1.1 及以下被拒绝

### 5.2 访问控制验收 ⏳ 待验收

**验收项 1: API Key 认证**
- **测试**: 
  1. 不带 Key 请求 -> 401
  2. 带错误 Key 请求 -> 401
  3. 带正确 Key 请求 -> 200
- **验收标准**: 认证机制生效

**验收项 2: API 限流**
- **测试**: 单 IP 发送 1500 QPS
- **验收标准**: 
  - [ ] 超过 1000 QPS 的请求被拒绝（429 状态码）
  - [ ] 返回清晰的限流提示

### 5.3 审计日志验收 ⏳ 待验收

**验收项: 日志完整性**
- **测试**: 执行 10 次配置变更
- **验收标准**: 
  - [ ] 所有操作被记录
  - [ ] 日志包含：时间、操作人、IP、操作内容、结果
  - [ ] 日志不可删除或篡改

---

## 六、端到端用户流程验收

### 流程 1: 新业务系统接入完整流程 ⏳ 待验收

**角色**: 业务系统开发者

**步骤**:

1. **查阅文档** ⏳ 待验收
   - 访问文档站点
   - 阅读快速开始指南
   - **验收标准**: 文档清晰，示例完整

2. **注册账号**（如需要）⏳ 待验收
   - 注册账号或申请权限
   - **验收标准**: 流程简单，审批及时

3. **创建配置** ⏳ 待验收
   - 登录管理后台
   - 按向导创建 workspace/group/biz_tag
   - 选择算法和格式
   - 生成 API Key
   - **验收标准**: 
     - [ ] 向导流程清晰
     - [ ] 有配置模板可选
     - [ ] 配置校验完善

4. **集成 SDK** ⏳ 待验收
   - 安装 SDK: `pip install idgen-client`
   - 编写代码：
     ```python
     client = IdGenClient('https://idgen.company.com', api_key='...')
     user_id = client.generate('my-ws', 'my-group', 'user-id')
     ```
   - **验收标准**: 
     - [ ] SDK 安装顺利
     - [ ] 代码示例可直接运行
     - [ ] 首次调用成功

5. **测试验证** ⏳ 待验收
   - 生成 100 个测试 ID
   - 验证 ID 唯一性
   - **验收标准**: 
     - [ ] ID 生成成功
     - [ ] 延迟符合预期

6. **上线监控** ⏳ 待验收
   - 在监控大盘添加业务标签
   - 配置告警规则
   - **验收标准**: 
     - [ ] 监控数据正常展示
     - [ ] 告警测试通过

**预期时间**: 从开始到完成 < 1 小时

---

### 流程 2: 运维故障处理流程 ⏳ 待验收

**角色**: SRE 工程师

**场景**: 收到数据库故障告警

**步骤**:

1. **接收告警** ⏳ 待验收
   - 企业微信/邮件收到告警
   - **验收标准**: 告警信息完整（故障类型、影响范围、建议措施）

2. **查看监控** ⏳ 待验收
   - 登录 Grafana 查看详细指标
   - 确认当前算法已降级至 Snowflake
   - **验收标准**: 监控数据实时更新，降级状态清晰展示

3. **故障处理** ⏳ 待验收
   - 排查数据库问题
   - 恢复数据库服务
   - **验收标准**: 系统自动检测到数据库恢复并切回 Segment 算法

4. **确认恢复** ⏳ 待验收
   - 查看服务状态
   - 确认 ID 生成正常
   - **验收标准**: 
     - [ ] 健康检查通过
     - [ ] QPS 恢复正常
     - [ ] 错误率归零

5. **事后分析** ⏳ 待验收
   - 查询审计日志
   - 生成故障报告
   - **验收标准**: 日志完整，可导出

**预期时间**: 故障发现到恢复 < 10 分钟

---

## 七、验收通过标准

### 7.1 功能验收标准

| 验收项 | 通过标准 | 状态 |
|-------|---------|------|
| **核心功能** | 所有业务场景通过 | ⏳ 待验收 |
| **管理功能** | 配置/监控/告警正常工作 | ⏳ 待验收 |
| **API 接口** | 所有端点正常响应 | ⏳ 待验收 |
| **跨 DC 部署** | ID 全局唯一，配置同步 | ⏳ 待验收 |

### 7.2 性能验收标准

| 指标 | 目标值 | 实测值 | 状态 |
|------|--------|--------|------|
| **单实例 QPS** | **> 1,000,000** | - | ⏳ 待验收 |
| **P99 延迟** | < 10ms | - | ⏳ 待验收 |
| **批量生成** | < 100ms (1000个) | - | ⏳ 待验收 |
| **内存占用** | < 4GB | - | ⏳ 待验收 |

### 7.3 可靠性验收标准

| 验收项 | 通过标准 | 状态 |
|-------|---------|------|
| **降级策略** | 故障自动降级，RTO < 1秒 | ⏳ 待验收 |
| **节点故障** | 单节点故障服务不中断 | ⏳ 待验收 |
| **滚动更新** | 更新无服务中断 | ⏳ 待验收 |
| **系统可用性** | > 99.9% | ⏳ 待验收 |

### 7.4 易用性验收标准

| 验收项 | 通过标准 | 状态 |
|-------|---------|------|
| **文档完整性** | 文档清晰，示例可运行 | ⏳ 待验收 |
| **接入时长** | 新系统接入 < 1 小时 | ⏳ 待验收 |
| **管理后台** | UX 评分 ≥ 4 分 | ⏳ 待验收 |

### 7.5 安全验收标准

| 验收项 | 通过标准 | 状态 |
|-------|---------|------|
| **传输加密** | 强制 HTTPS/TLS 1.3 | ⏳ 待验收 |
| **访问控制** | API Key 认证 + 限流生效 | ⏳ 待验收 |
| **审计日志** | 所有操作可追溯 | ⏳ 待验收 |

---

## 八、验收签字

### 8.1 验收参与方

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| **产品经理** | - | ⏳ 待签字 | - |
| **技术负责人** | - | ⏳ 待签字 | - |
| **业务方代表（订单系统）** | - | ⏳ 待签字 | - |
| **业务方代表（用户系统）** | - | ⏳ 待签字 | - |
| **SRE 负责人** | - | ⏳ 待签字 | - |
| **QA 负责人** | - | ⏳ 待签字 | - |

### 8.2 验收结论

**验收状态**: ⏳ 待验收

**遗留问题**: 
- （待填写）

**上线建议**:
- （待填写）

---

## 九、附录

### 9.1 验收检查清单

```
核心功能验收
[ ] 订单系统接入场景通过
[ ] 用户系统接入场景通过
[ ] 物流系统接入场景通过
[ ] 跨数据中心部署验证通过

管理功能验收
[ ] 配置管理界面易用
[ ] 监控大盘数据准确
[ ] 告警功能正常
[ ] 审计日志完整

性能验收
[ ] QPS > 1,000,000
[ ] P99 < 10ms
[ ] 批量生成 < 100ms

可靠性验收
[ ] 数据库故障降级正常
[ ] Redis 故障容错正常
[ ] 时钟回拨处理正常 (三级策略)
[ ] 节点故障自愈正常

易用性验收
[ ] 文档清晰完整
[ ] API 易于集成
[ ] 管理后台 UX ≥ 4分

安全验收
[ ] HTTPS 强制
[ ] API Key 认证生效
[ ] API 限流生效
[ ] 审计日志完整
```

### 9.2 验收工具清单

| 工具 | 用途 |
|------|------|
| **Postman** | API 功能测试 |
| **wrk** | 性能压测 |
| **浏览器开发者工具** | 管理后台测试 |
| **Grafana** | 监控验证 |
| **数据库客户端** | 数据验证 |

---

**文档状态**: ⏳ 待验收  
**预计验收日期**: 待定  
**验收负责人**: 产品经理 + 业务方代表